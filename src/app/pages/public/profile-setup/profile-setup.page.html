<ion-header>
  <ion-toolbar color="primary">
    <ion-buttons slot="secondary">
      <ion-button (click)="presentExitAlert()" aria-label="Close setup">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
    @if (currentStep() === 2) {
    <ion-buttons slot="primary">
      <ion-button
        [attr.aria-label]="'Use my location'"
        (click)="onUseMyLocationClick()"
      >
        <ion-icon slot="icon-only" name="locate"></ion-icon>
      </ion-button>
    </ion-buttons>
    } <ion-title>Profile Setup</ion-title>
  </ion-toolbar>
  <div class="progress-container ion-padding-horizontal ion-padding-vertical">
    <div class="progress-stack">
      <div class="dots">
        <span [class.active]="currentStep() >= 1">1</span>
        <span [class.active]="currentStep() >= 2">2</span>
        <span [class.active]="currentStep() >= 3">3</span>
        <span [class.active]="currentStep() >= 4">4</span>
      </div>
      <div class="track">
        <div class="fill" [style.width.%]="progress() * 100"></div>
      </div>
    </div>
  </div>
</ion-header>
<ion-content class="setup-content ion-padding" [scrollY]="currentStep() !== 2">
  @if (currentStep() === 1) {
  <form id="personalForm" [formGroup]="personalForm" (ngSubmit)="next()">
    <section class="section-card form-card">
      <div class="section-header"><h2>Personal details</h2></div>
      <ion-list lines="none" class="form-list">
        <ion-item>
          <ion-input
            label="First name"
            labelPlacement="stacked"
            placeholder="First name"
            formControlName="firstName"
            required
          ></ion-input>
        </ion-item>
        <ion-item>
          <ion-input
            label="Surname"
            labelPlacement="stacked"
            placeholder="Surname"
            formControlName="lastName"
            required
          ></ion-input>
        </ion-item>
        <ion-item>
          <ion-select
            label="Sex"
            labelPlacement="stacked"
            formControlName="sex"
            interface="popover"
            justify="start"
          >
            <ion-select-option value="Male">Male</ion-select-option>
            <ion-select-option value="Female">Female</ion-select-option>
            <ion-select-option value="Other">Other</ion-select-option>
          </ion-select>
        </ion-item>
      </ion-list>
    </section>
  </form>
  } @if (currentStep() === 2) {
  <app-location-picker
    (changed)="onLocationSelected($event)"
    [initialPlace]="''"
    [initialLat]="null"
    [initialLng]="null"
    [initialRadiusMiles]="15"
  >
  </app-location-picker>
  } @if (currentStep() === 3) {
  <form id="payTradeForm" [formGroup]="payTradeForm" (ngSubmit)="next()">
    <section class="section-card form-card">
      <div class="section-header"><h2>Pay &amp; trade</h2></div>
      <ion-list lines="none" class="form-list">
        <ion-item lines="none" class="range-header-item">
          <ion-label>Pay expectation</ion-label>
          <ion-note slot="end"
            >£{{ payTradeForm.get('expectedPay')?.value }} / h</ion-note
          >
        </ion-item>

        <ion-item lines="none">
          <ion-range
            [attr.aria-label]="'Pay Expectation'"
            formControlName="expectedPay"
            min="5"
            max="100"
            step="1"
            ><ion-text slot="start">£0</ion-text>
            <ion-text slot="end">£100</ion-text></ion-range
          >
        </ion-item>
        <ion-item button detail="true" (click)="openModal('trade')">
          <ion-label>
            <h3>Trade</h3>
            @if (payTradeForm.get('tradeId')?.value) {
            <p>{{ selectedTradeName() }}</p>
            }
          </ion-label>
        </ion-item>
        <ion-item
          button
          detail="true"
          (click)="openModal('subcategories')"
          [disabled]="!subcategories().length"
        >
          <ion-label>
            <h3>Trade sub-categories</h3>
            @if (selectedSubcatNames().length) {
            <p>{{selectedSubcatNames()}}</p>
            }
          </ion-label>
        </ion-item>
      </ion-list>
    </section>
    <section class="section-card form-card">
      <ion-list lines="none" class="form-list">
        <ion-item
          button
          detail="true"
          (click)="openModal('certificates')"
          [disabled]="!tradeSelected()"
          [attr.aria-disabled]="!tradeSelected()"
        >
          <ion-label>
            <h3>Certificates (optional)</h3>

            @if (!tradeSelected()) {
            <p>Select a trade first</p>
            } @else if (payTradeForm.get('certificates')?.value?.length) {
            <p>{{ payTradeForm.get('certificates')?.value.length }} selected</p>
            }
          </ion-label>
        </ion-item>
      </ion-list>
    </section>
  </form>
  } @if (currentStep() === 4) {
  <form id="bankForm" [formGroup]="bankForm" (ngSubmit)="submit()">
    <section class="section-card form-card">
      <div class="section-header"><h2>Payment details</h2></div>
      <ion-list lines="none" class="form-list">
        <ion-item>
          <ion-input
            label="Bank account number"
            labelPlacement="stacked"
            placeholder="Account number"
            formControlName="bankAccountNumber"
          ></ion-input>
        </ion-item>
        <ion-item>
          <ion-input
            label="Sort code"
            labelPlacement="stacked"
            placeholder="Sort code"
            formControlName="bankSortCode"
          ></ion-input>
        </ion-item>
        <ion-item>
          <ion-input
            label="NI number"
            labelPlacement="stacked"
            placeholder="NI number"
            formControlName="niNumber"
          ></ion-input>
        </ion-item>
      </ion-list>
    </section>
  </form>
  }
  <div class="bottom-spacer" aria-hidden="true"></div>
</ion-content>
<ion-footer>
  <ion-toolbar class="cta-toolbar">
    @if (currentStep() === 1) {
    <ion-button
      expand="block"
      class="primary-btn"
      [disabled]="personalForm.invalid"
      (click)="next()"
      >Next</ion-button
    >
    } @else if (currentStep() === 2) {
    <ion-button
      expand="block"
      class="ion-margin-bottom"
      (click)="onOpenRadiusClick()"
    >
      Set radius - {{ selectedRadiusMiles() }} miles
    </ion-button>
    <div class="cta-row">
      <ion-button
        class="ghost-btn"
        fill="outline"
        color="primary"
        (click)="back()"
        >Back</ion-button
      >
      <ion-button
        class="primary-btn"
        (click)="next()"
        [disabled]="!locationSelected()"
        >Next</ion-button
      >
    </div>
    } @else if (currentStep() === 3) {
    <div class="cta-row">
      <ion-button
        class="ghost-btn"
        fill="outline"
        color="primary"
        (click)="back()"
        >Back</ion-button
      >
      <ion-button
        class="primary-btn"
        (click)="next()"
        [disabled]="payTradeForm.invalid"
        >Next</ion-button
      >
    </div>
    } @else if (currentStep() === 4) {
    <div class="cta-row">
      <ion-button
        class="ghost-btn"
        fill="outline"
        color="primary"
        (click)="back()"
        >Back</ion-button
      >
      <ion-button
        class="primary-btn"
        [disabled]="bankForm.invalid"
        (click)="submit()"
        >Submit</ion-button
      >
    </div>
    }
  </ion-toolbar>
</ion-footer>
