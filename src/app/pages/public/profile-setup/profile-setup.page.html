<ion-header no-shadow>
  <app-toolbar-back
    [title]="headerTitle()"
    [profileStep]="headerStep()"
    [navigation]="'/login'"
    [confirmOnBack]="true"
  ></app-toolbar-back>
</ion-header>

<ion-content class="setup-page ion-padding-horizontal">
  @if (currentStep() === 1) {
  <section class="section-card photo-card" aria-labelledby="photoPromptTitle">
    <div class="photo-row">
      <div class="photo-illustration" role="img" aria-label="Profile photo">
        @if (avatarLoaded()) {
        <ion-avatar>
          <img [src]="avatarSrc()" alt="Profile photo" />
        </ion-avatar>
        } @else {
        <ion-icon name="person-circle-outline" aria-hidden="true"></ion-icon>
        }
      </div>

      <div class="photo-copy ion-padding-horizontal">
        <h3 id="photoPromptTitle" class="sr-only">Profile photo</h3>
        <p class="photo-text ion-padding-top">
          Upload your photo to increase your chances of finding a job
        </p>

        <ion-button
          class="add-image-btn"
          size="small"
          (click)="openAvatarSheet()"
        >
          Add image
        </ion-button>
      </div>
    </div>
  </section>

  <form [formGroup]="personalForm" (ngSubmit)="next()" novalidate>
    <ion-list lines="none" class="form-list">
      <label class="field-label ion-padding" for="first-name">Name</label>
      <ion-item class="input-item" lines="none">
        <ion-input
          id="first-name"
          formControlName="firstName"
          type="text"
          placeholder="Enter name"
          autocomplete="name"
          inputmode="text"
          required
        ></ion-input>
      </ion-item>

      <label class="field-label ion-padding" for="last-name">Last name</label>
      <ion-item class="input-item" lines="none">
        <ion-input
          id="last-name"
          formControlName="lastName"
          type="text"
          placeholder="Enter last name"
          autocomplete="family-name"
          inputmode="text"
          required
        ></ion-input>
      </ion-item>

      <label class="field-label ion-padding" for="sex-select">Gender</label>
      <ion-item class="input-item" lines="none">
        <ion-select
          id="sex-select"
          formControlName="sex"
          interface="popover"
          justify="start"
          placeholder="Select"
          required
        >
          <ion-select-option value="Male">Male</ion-select-option>
          <ion-select-option value="Female">Female</ion-select-option>
        </ion-select>
      </ion-item>
    </ion-list>
  </form>
  } @else if (currentStep() === 2) {
  <section class="section-card map-card">
    <app-location-picker
      (changed)="onLocationSelected($event)"
      [initialPlace]="''"
      [initialLat]="null"
      [initialLng]="null"
      [initialRadiusMiles]="selectedRadiusMiles()"
    >
    </app-location-picker>
  </section>
  } @else if (currentStep() === 3) {
  <form [formGroup]="payTradeForm" novalidate>
    <section class="section-card form-card ion-padding-top">
      <h2 class="section-title">Expectation</h2>

      <ion-item lines="none" class="range-header-item ion-no-padding">
        <ion-label>Hourly Rate</ion-label>
      </ion-item>
      <ion-item lines="none" class="ion-no-padding">
        <ion-range
          class="ion-no-padding"
          aria-label="Hourly Rate"
          [pin]="true"
          [pinFormatter]="formatHourly"
          min="5"
          max="100"
          step="1"
          formControlName="hourlyRate"
        ></ion-range>
      </ion-item>

      <ion-item
        lines="none"
        class="range-header-item divider-top ion-no-padding"
      >
        <ion-label>Day Rate</ion-label>
      </ion-item>
      <ion-item lines="none" class="ion-no-padding">
        <ion-range
          class="ion-no-padding"
          aria-label="Day Rate"
          [pin]="true"
          [pinFormatter]="formatDaily"
          min="50"
          max="1000"
          step="10"
          formControlName="dayRate"
        ></ion-range>
      </ion-item>
    </section>

    <section class="section-card form-card">
      <h2 class="section-title">Role</h2>

      <label class="field-label ion-padding">Trade category</label>
      <ion-item
        button
        detail="true"
        class="input-item selectish"
        lines="none"
        (click)="openModal('trade')"
      >
        <ion-label>
          <div class="placeholder">Select your main trade</div>
        </ion-label>
      </ion-item>

      @if (tradeId()) {
      <div class="chip-row">
        <ion-chip class="pill">
          {{ selectedTradeName() }}
          <ion-icon name="close" (click)="setTrade(null)"></ion-icon>
        </ion-chip>
      </div>
      }

      <div class="hr"></div>

      <label class="field-label ion-padding">Trade sub-category</label>
      <ion-item
        button
        detail="true"
        class="input-item selectish"
        lines="none"
        [disabled]="!tradeId()"
        [attr.aria-disabled]="!tradeId()"
        (click)="openModal('subcategories')"
      >
        <ion-label>
          <div class="placeholder">
            @if (!tradeId()) { Choose a trade first } @else { Select
            sub-categories }
          </div>
        </ion-label>
      </ion-item>

      @if (subcatIds().length) {
      <div class="chip-row">
        @for (s of subcategories(); track s.id) { @if
        (subcatIds().includes(s.id)) {
        <ion-chip class="pill">
          {{ s.name }}
          <ion-icon name="close" (click)="removeSubcategory(s.id)"></ion-icon>
        </ion-chip>
        } }
      </div>
      }
    </section>
  </form>
  } @else if (currentStep() === 4) {

  <section class="section-card form-card ion-padding">
    @if (certLoading()) {
    <div class="loading-row" role="status" aria-live="polite">
      <ion-spinner></ion-spinner>
      <ion-note>Loading certificates…</ion-note>
    </div>
    } @else if (certLoadError()) {
    <ion-note color="danger" class="block-note">{{ certLoadError() }}</ion-note>
    } @else if (!certHasData()) {
    <ion-note class="block-note"
      >No certificates found for this trade.</ion-note
    >
    } @else {

    <section class="hero-card" aria-label="Certificate uploader introduction">
      <div class="hero-icon">
        <ion-icon name="document-outline" aria-hidden="true"></ion-icon>
      </div>
      <div class="hero-text">
        <h2 class="hero-title">Add your certifications</h2>
        <p class="hero-subtitle">
          Verified cards and certificates help clients trust your profile and
          get you placed faster. @if (selectedTradeName()) {
          <strong>Selected trade: {{ selectedTradeName() }}</strong>
          }
        </p>
        <ul class="hero-checklist">
          <li><span class="dot"></span> Upload a clear photo or PDF</li>
          <li>
            <span class="dot"></span> Make sure the name & expiry are visible
          </li>
          <li><span class="dot"></span> Add “Other” if it's not listed</li>
        </ul>
        <div class="format-row" aria-label="Supported file types">
          <ion-chip>PDF</ion-chip>
          <ion-chip>PNG</ion-chip>
          <ion-chip>JPG</ion-chip>
          <ion-chip>HEIC</ion-chip>
        </div>
      </div>
    </section>

    <ion-list>
      <ion-item>
        <ion-select
          label="Select Certificate"
          placeholder="Choose certificate"
          [value]="certSelectedId()"
          (ionChange)="certOnSelectionChange($event.detail.value)"
        >
          @for (c of certOptions(); track c.id) {
          <ion-select-option [value]="c.id">{{ c.name }}</ion-select-option>
          }
        </ion-select>
      </ion-item>
    </ion-list>

    <section class="big-upload">
      @if (certWarn()) {
      <ion-note color="warning" class="block-note">{{ certWarn() }}</ion-note>
      }

      <button
        class="dropzone"
        type="button"
        [disabled]="!certCanUploadForCurrent()"
        (click)="certOpenUploadSheet(nativeFileInput)"
        aria-label="Upload certificate file"
      >
        <ion-icon name="cloud-upload-outline" aria-hidden="true"></ion-icon>
        <div class="dz-text">
          <div class="dz-title">
            @if (certHasReachedMax()) { Uploads limited to 5 } @else { Upload
            certificate }
          </div>
          <div class="dz-sub">
            @if (certSelectedId() === null) { Select a certificate above to
            continue } @else if (certSelectedId() === -1 &&
            !certOtherName().trim()) { Enter the “Other” certificate name to
            continue } @else if (certHasUploadForCurrent()) { You've already
            added a file for this certificate } @else if (certHasReachedMax()) {
            Remove one to add another (max 5) } @else { Choose from library,
            take a photo, or pick a file }
          </div>
        </div>
      </button>

      <input
        #nativeFileInput
        type="file"
        accept="image/*,application/pdf"
        hidden
        (change)="certOnNativeFileChosen($event)"
      />
    </section>

    @if (certSelectedId() === -1) {
    <ion-list class="stacked-list">
      <ion-item lines="none" class="other-name">
        <ion-label position="stacked">Enter certificate name</ion-label>
        <ion-input
          [value]="certOtherName()"
          (ionInput)="certSetOtherName($event.detail.value ?? '')"
          [disabled]="certHasUploadForCurrent()"
          placeholder="e.g. City & Guilds Level 3 – custom"
          maxlength="80"
          inputmode="text"
        ></ion-input>
        <ion-note class="hint">
          @if (certHasUploadForCurrent()) { Name locked after upload. } @else {
          Required for “Other”. }
        </ion-note>
      </ion-item>
    </ion-list>
    } @if (certAllUploads().length > 0) {
    <section class="preview-section">
      <div class="preview-header">
        <div class="ph-left">
          <strong>{{ certAllUploads().length }}</strong>
          file{{ certAllUploads().length === 1 ? "" : "s" }} selected
          <span class="muted"> (max {{ 5 }})</span>
        </div>
      </div>

      <div class="preview-grid">
        @for (u of certAllUploads(); track u.item.url) {
        <figure class="preview-card">
          @if (u.item.mime.startsWith('image/')) {
          <img [src]="u.item.url" alt="Selected image" />
          } @else {
          <div class="pdf-icon" aria-label="PDF file">
            <ion-icon name="document-outline"></ion-icon>
          </div>
          }
          <figcaption class="preview-caption">
            <div class="cap-name">{{ u.item.name }}</div>
            <div class="cap-cert">{{ u.label }}</div>
          </figcaption>
          <button
            class="remove-btn"
            type="button"
            (click)="certRemoveUploadByKey(u.key)"
            aria-label="Remove file"
          >
            <ion-icon name="trash-outline"></ion-icon>
          </button>
        </figure>
        }
      </div>
    </section>
    } }
  </section>
  }

  <div class="bottom-spacer" aria-hidden="true"></div>
</ion-content>

<ion-footer class="ion-no-border ion-padding">
  <ion-toolbar class="cta-toolbar">
    @if (currentStep() === 1) {
    <ion-button
      expand="block"
      [disabled]="personalForm.invalid"
      (click)="next()"
      >Next</ion-button
    >
    } @else if (currentStep() === 2) {
    <ion-button expand="block" (click)="onOpenRadiusClick()">
      Set radius - {{ selectedRadiusMiles() }} miles
    </ion-button>
    <div class="cta-row">
      <ion-button class="ghost-btn" fill="outline" (click)="back()"
        >Previous Step</ion-button
      >
      <ion-button (click)="goToStep3()" [disabled]="!locationSelected()"
        >Next</ion-button
      >
    </div>
    } @else if (currentStep() === 3) {
    <div class="cta-row">
      <ion-button class="ghost-btn" fill="outline" (click)="back()"
        >Previous Step</ion-button
      >
      <ion-button (click)="next()" [disabled]="payTradeForm.invalid"
        >Next</ion-button
      >
    </div>
    } @else if (currentStep() === 4) {
    <div class="cta-row">
      <ion-button class="ghost-btn" fill="outline" (click)="back()"
        >Previous Step</ion-button
      >
      <ion-button [disabled]="certSubmitting()" (click)="submit()"
        >Submit</ion-button
      >
    </div>
    }
  </ion-toolbar>
</ion-footer>

<ion-action-sheet
  [isOpen]="isAvatarSheetOpen()"
  (didDismiss)="isAvatarSheetOpen.set(false)"
  header="Add profile photo"
  [buttons]="[
    { text: 'Take photo', icon: 'camera-outline', role: 'camera' },
    { text: 'Choose from library', icon: 'image-outline', role: 'photos' },
    { text: 'Cancel', role: 'cancel' }
  ]"
  (ionActionSheetDidDismiss)="onActionSheetDismiss($event)"
>
</ion-action-sheet>

<ion-loading
  [isOpen]="isUploading()"
  message="Processing photo..."
></ion-loading>

<ion-toast
  [isOpen]="toastMsg() !== ''"
  [message]="toastMsg()"
  duration="1600"
  (didDismiss)="toastMsg.set('')"
></ion-toast>
