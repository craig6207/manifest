<ion-header class="jobs-header">
  <app-toolbar-back
    title="Jobs List"
    [backButtonShow]="false"
  ></app-toolbar-back>

  <ion-button
    class="header-filter-btn"
    fill="solid"
    (click)="openFilter()"
    aria-label="Filter jobs"
  >
    <ion-icon slot="icon-only" name="filter-sharp"></ion-icon>
  </ion-button>
</ion-header>

<ion-content
  [fullscreen]="true"
  class="ion-padding"
  fixed-slot-placement="before"
>
  @if (loading()) {
  <ion-skeleton-text
    animated
    style="width: 70%; height: 22px"
  ></ion-skeleton-text>
  <ion-skeleton-text
    animated
    style="width: 95%; height: 18px; margin-top: 8px"
  ></ion-skeleton-text>
  <ion-skeleton-text
    animated
    style="width: 85%; height: 18px; margin-top: 8px"
  ></ion-skeleton-text>
  } @else if (error()) {
  <ion-note color="danger">{{ error() }}</ion-note>
  } @else {
  <ion-list class="job-list" lines="none">
    @for (job of jobs(); track job.id) {
    <div class="job-card">
      <div class="job-card-top">
        <div class="job-card-heading">
          <h3 class="job-title">{{ job.trade }} {{ job.tradeSubCategory }}</h3>
        </div>

        <button type="button" class="job-favourite-btn" aria-label="Save job">
          <ion-icon name="heart-outline" aria-hidden="true"></ion-icon>
        </button>
      </div>

      <div class="job-meta-row">
        <div class="job-meta">
          <ion-icon name="location-outline" class="job-meta-icon"></ion-icon>
          <span>{{ job.location || 'Within your preferred area' }}</span>
        </div>

        <span class="job-meta-divider">|</span>

        <div class="job-meta">
          <ion-icon name="briefcase-outline" class="job-meta-icon"></ion-icon>
          <span>
            {{ job.hours && job.hours.length ? job.hours[0] : 'Full-time' }}
          </span>
        </div>

        <span class="job-meta-divider">|</span>

        <div class="job-meta">
          <ion-icon name="time-outline" class="job-meta-icon"></ion-icon>
          <span>
            {{ job.startDate | date: 'EEE, d MMM' }} – {{ job.endDate |
            date:'EEE, d MMM' }}
          </span>
        </div>
      </div>

      <p class="job-description">{{ job.projectInfo }}</p>

      <div class="job-card-footer">
        <p class="job-salary">£{{ job.payRate }}/h</p>

        <button
          type="button"
          class="job-link"
          (click)="openJob(job)"
          aria-label="View job details"
        >
          <span>View Details</span>
          <ion-icon name="arrow-forward-outline" aria-hidden="true"></ion-icon>
        </button>
      </div>
    </div>
    } @if (jobs().length === 0) {
    <div class="empty-state">
      <div class="empty-icon">
        <ion-icon name="briefcase-outline" aria-hidden="true"></ion-icon>
      </div>
      <h3 class="empty-title">No jobs match your criteria</h3>
      <p class="empty-text">
        Try adjusting your filters to see more roles in your area.
      </p>
      <ion-button
        expand="block"
        class="empty-btn"
        (click)="goToPreferences()"
        aria-label="Update job preferences"
      >
        Update preferences
      </ion-button>
    </div>
    }
  </ion-list>
  }

  <ion-modal
    [isOpen]="filterOpen()"
    (didDismiss)="closeFilter()"
    [initialBreakpoint]="'0.90'"
    aria-label="Filter jobs"
    class="filter-sheet"
  >
    <ng-template>
      <ion-header>
        <ion-toolbar>
          <ion-buttons slot="start">
            <ion-button fill="clear" (click)="closeFilter()" aria-label="Close">
              <ion-icon name="close-outline"></ion-icon>
            </ion-button>
          </ion-buttons>

          <ion-title>Filter Jobs</ion-title>

          <ion-buttons slot="end">
            <ion-button
              fill="clear"
              (click)="resetFilters()"
              aria-label="Reset filters"
            >
              Reset
            </ion-button>
          </ion-buttons>
        </ion-toolbar>
      </ion-header>

      <ion-content class="ion-padding">
        <section
          class="filter-section location-section section-end ion-padding-vertical"
        >
          <div class="location-row">
            <h2 class="section-heading">Location</h2>
            <div class="location-right">
              <ion-chip
                class="location-chip"
                (click)="openRadiusSheet()"
                aria-label="Change search radius"
              >
                +{{ radius() }} miles
              </ion-chip>
            </div>
          </div>
        </section>

        <section class="filter-section section-end ion-padding-vertical">
          <h2 class="section-heading">Trade sub categories</h2>
          <div class="roles-grid">
            @for (sub of availableSubcategories(); track sub) {
            <ion-chip
              class="ion-no-margin trade-chip"
              [outline]="!selectedSubcategories().includes(sub)"
              (click)="toggleSubcategory(sub)"
              [class.trade-chip-selected]="selectedSubcategories().includes(sub)"
            >
              <ion-icon name="swap-horizontal-outline"></ion-icon>
              <ion-label>{{ sub }}</ion-label>
            </ion-chip>
            }
          </div>
        </section>

        <section
          class="filter-section pay-section section-end ion-padding-vertical"
        >
          <h2 class="section-heading">Pay</h2>

          <ion-item lines="none" class="range-header-item ion-no-padding">
            <ion-label>Hourly rate</ion-label>
          </ion-item>
          <ion-item lines="none" class="range-item ion-no-padding">
            <ion-range
              aria-label="Hourly rate"
              [pin]="true"
              [pinFormatter]="formatHourly"
              [min]="hourlyMin"
              [max]="hourlyMax"
              [step]="1"
              [value]="hourlyRate() ?? hourlyMin"
              (ionChange)="setHourlyRate($any($event.detail.value))"
            ></ion-range>
          </ion-item>
        </section>

        <section class="filter-section dates-section ion-padding-vertical">
          <h2 class="section-heading">Dates</h2>

          <div class="dates-block">
            <div class="date-row">
              <div class="date-label">Start date</div>
              <div class="date-inputs">
                <ion-item lines="none" class="date-item">
                  <ion-select
                    interface="popover"
                    placeholder="Day"
                    fill="outline"
                    [value]="startDay()"
                    (ionChange)="onStartDayChange($event.detail.value)"
                  >
                    @for (d of days; track d) {
                    <ion-select-option [value]="d">{{ d }}</ion-select-option>
                    }
                  </ion-select>
                </ion-item>

                <ion-item lines="none" class="date-item">
                  <ion-select
                    interface="popover"
                    placeholder="Month"
                    fill="outline"
                    [value]="startMonth()"
                    (ionChange)="onStartMonthChange($event.detail.value)"
                  >
                    @for (m of months; track m.value) {
                    <ion-select-option [value]="m.value">
                      {{ m.label }}
                    </ion-select-option>
                    }
                  </ion-select>
                </ion-item>

                <ion-item lines="none" class="date-item">
                  <ion-select
                    interface="popover"
                    placeholder="Year"
                    fill="outline"
                    [value]="startYear()"
                    (ionChange)="onStartYearChange($event.detail.value)"
                  >
                    @for (y of years; track y) {
                    <ion-select-option [value]="y">{{ y }}</ion-select-option>
                    }
                  </ion-select>
                </ion-item>
              </div>
            </div>

            <div class="date-row">
              <div class="date-label">End date</div>
              <div class="date-inputs">
                <ion-item lines="none" class="date-item">
                  <ion-select
                    interface="popover"
                    placeholder="Day"
                    fill="outline"
                    [value]="endDay()"
                    (ionChange)="onEndDayChange($event.detail.value)"
                  >
                    @for (d of days; track d) {
                    <ion-select-option [value]="d">{{ d }}</ion-select-option>
                    }
                  </ion-select>
                </ion-item>

                <ion-item lines="none" class="date-item">
                  <ion-select
                    interface="popover"
                    placeholder="Month"
                    fill="outline"
                    [value]="endMonth()"
                    (ionChange)="onEndMonthChange($event.detail.value)"
                  >
                    @for (m of months; track m.value) {
                    <ion-select-option [value]="m.value">
                      {{ m.label }}
                    </ion-select-option>
                    }
                  </ion-select>
                </ion-item>

                <ion-item lines="none" class="date-item">
                  <ion-select
                    interface="popover"
                    placeholder="Year"
                    fill="outline"
                    [value]="endYear()"
                    (ionChange)="onEndYearChange($event.detail.value)"
                  >
                    @for (y of years; track y) {
                    <ion-select-option [value]="y">{{ y }}</ion-select-option>
                    }
                  </ion-select>
                </ion-item>
              </div>
            </div>
          </div>
          <ion-button
            expand="block"
            size="large"
            class="ion-padding ion-margin-bottom"
            color="primary"
            (click)="applyFilters()"
          >
            Update filters
          </ion-button>
        </section>

        <div class="content-spacer" aria-hidden="true"></div>
      </ion-content>
    </ng-template>
  </ion-modal>
</ion-content>
