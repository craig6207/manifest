<ion-header>
  <app-toolbar-back
    [title]="'Job preferences'"
    [navigation]="'/secure/tabs/profile'"
  ></app-toolbar-back>
</ion-header>

<ion-content [fullscreen]="true" class="profile-details job-prefs-page">
  @if (loading() || !jobPreferences()) {
  <div class="details-inner">
    <section class="summary-card">
      <div class="icon-badge">
        <ion-skeleton-text
          animated
          style="width: 40px; height: 40px; border-radius: 9999px"
        ></ion-skeleton-text>
      </div>
      <div class="summary">
        <div class="name">
          <ion-skeleton-text
            animated
            style="width: 60%; height: 18px"
          ></ion-skeleton-text>
        </div>
        <div class="meta">
          <ion-skeleton-text
            animated
            style="width: 40%; height: 14px"
          ></ion-skeleton-text>
        </div>
        <div class="meta">
          <ion-skeleton-text
            animated
            style="width: 30%; height: 14px"
          ></ion-skeleton-text>
        </div>
      </div>
    </section>

    <section class="form-card">
      <div class="section-header">
        <h2>
          <ion-skeleton-text
            animated
            style="width: 160px; height: 20px"
          ></ion-skeleton-text>
        </h2>
      </div>

      <ion-list lines="none" class="form-list">
        @for (i of [1,2,3,4,5,6]; track i) {
        <ion-item class="input-item ion-margin-bottom">
          <div style="width: 100%; margin-top: 4px">
            <ion-skeleton-text
              animated
              style="width: 100%; height: 40px; border-radius: 12px"
            ></ion-skeleton-text>
          </div>
        </ion-item>
        }
      </ion-list>
    </section>

    <div class="bottom-spacer" aria-hidden="true"></div>
  </div>
  } @else {
  <div class="details-inner">
    <form [formGroup]="form" (ngSubmit)="onSave()">
      <section class="form-card ion-padding-bottom">
        <div class="section-header">
          <h2 class="ion-padding-bottom">Location &amp; pay</h2>
        </div>

        <ion-list lines="none" class="form-list">
          <label class="field-label ion-padding-bottom" for="jp-location-name">
            Location
          </label>

          <ion-item
            class="input-item ion-margin-bottom"
            [class.is-invalid]="
    form.get('locationName')?.invalid &&
    form.get('locationName')?.touched
  "
            button
            detail="true"
            (click)="onLocationClick()"
          >
            <ion-input
              id="jp-location-name"
              formControlName="locationName"
              placeholder="Select preferred location"
              autocapitalize="words"
              [readonly]="true"
            ></ion-input>
          </ion-item>

          @if (form.get('locationName')?.invalid &&
          form.get('locationName')?.touched) {
          <div class="error">Location is required.</div>
          }

          <label class="field-label ion-padding-bottom" for="jp-radius-miles">
            Distance radius (miles)
          </label>

          <ion-item
            class="input-item ion-margin-bottom"
            button
            detail="true"
            (click)="openRadiusSheet()"
          >
            <ion-label id="jp-radius-miles">
              <div class="placeholder">
                {{ form.get('radiusMiles')?.value || 15 }} miles
              </div>
            </ion-label>
          </ion-item>

          <label class="field-label ion-padding-bottom" for="jp-hourly-rate">
            Hourly rate
          </label>
          <ion-item class="range-item ion-no-padding">
            <ion-range
              id="jp-hourly-rate"
              formControlName="hourlyRate"
              [pin]="true"
              [pinFormatter]="formatHourly"
              min="5"
              max="100"
              step="1"
            ></ion-range>
          </ion-item>

          <label class="field-label ion-padding-bottom" for="jp-day-rate">
            Day rate
          </label>
          <ion-item class="range-item ion-no-padding">
            <ion-range
              id="jp-day-rate"
              formControlName="dayRate"
              [pin]="true"
              [pinFormatter]="formatDaily"
              min="50"
              max="1000"
              step="10"
            ></ion-range>
          </ion-item>
        </ion-list>
      </section>

      <section class="form-card">
        <div class="section-header">
          <h2 class="ion-padding-bottom">Role</h2>
        </div>

        <ion-list lines="none" class="form-list">
          <label class="field-label ion-padding-bottom"> Trade category </label>
          <ion-item
            button
            detail="true"
            class="input-item selectish ion-margin-bottom"
            lines="none"
            (click)="openModal('trade')"
          >
            <ion-label>
              <div class="placeholder">
                @if (!selectedTradeName()) { Select your main trade } @else {{{
                selectedTradeName() }}}
              </div>
            </ion-label>
          </ion-item>

          <label class="field-label ion-padding-bottom">
            Trade sub-categories
          </label>
          <ion-item
            button
            detail="true"
            class="input-item selectish ion-margin-bottom"
            lines="none"
            [disabled]="!tradeId()"
            [attr.aria-disabled]="!tradeId()"
            (click)="openModal('subcategories')"
          >
            <ion-label>
              <div class="placeholder">Select sub-categories</div>
            </ion-label>
          </ion-item>

          @if (selectedSubcatNames().length) {
          <div class="chip-row">
            @for (s of subcategories(); track s.id) { @if
            (subcatIds().includes(s.id)) {
            <ion-chip class="pill">
              {{ s.name }}
              <ion-icon
                name="close"
                (click)="removeSubcategory(s.id)"
              ></ion-icon>
            </ion-chip>
            } } @if (!subcategories().length) { @for (name of
            selectedSubcatNames(); track name) {
            <ion-chip class="pill"> {{ name }} </ion-chip>
            } }
          </div>
          }
        </ion-list>
      </section>

      <div class="bottom-spacer" aria-hidden="true"></div>
    </form>
  </div>
  }
</ion-content>

<ion-footer style="background-color: #f4f8fb" class="ion-padding ion-no-border">
  <ion-toolbar>
    <ion-button
      type="submit"
      expand="block"
      color="primary"
      [disabled]="disableSave()"
      (click)="onSave()"
    >
      Save changes
    </ion-button>
  </ion-toolbar>
</ion-footer>

<ion-modal
  [isOpen]="locationModalOpen()"
  (didDismiss)="closeLocationPicker()"
  [initialBreakpoint]="'0.95'"
  class="location-picker-sheet"
>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <div class="modal-title">Choose location</div>
        <ion-button
          slot="end"
          fill="clear"
          (click)="closeLocationPicker()"
          aria-label="Done choosing location"
        >
          Done
        </ion-button>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <app-location-picker
        [initialPlace]="
          (form.get('locationName')?.value || jobPreferences()?.locationName) || ''
        "
        [initialLat]="jobPreferences()?.locationLat ?? null"
        [initialLng]="jobPreferences()?.locationLng ?? null"
        [initialRadiusMiles]="form.get('radiusMiles')?.value || 15"
        (changed)="onLocationChanged($event)"
      >
      </app-location-picker>
    </ion-content>
  </ng-template>
</ion-modal>
