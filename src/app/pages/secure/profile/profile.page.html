<ion-header class="profile-header">
  <ion-toolbar class="toolbar-profile">
    <ion-buttons slot="start">
      <ion-button
        fill="clear"
        size="small"
        class="back-btn"
        aria-label="Settings"
        (click)="openSettings()"
      >
        <ion-icon name="settings-outline" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>

    <ion-buttons slot="end">
      <ion-button
        fill="clear"
        size="small"
        class="icon-btn notifications-btn"
        aria-label="Notifications"
        (click)="openNotifications()"
      >
        <ion-icon name="notifications-outline" slot="icon-only"></ion-icon>
        @if (hasNotifications()) {
        <ion-badge class="notification-badge">
          {{ unreadBadgeText() }}
        </ion-badge>
        }
      </ion-button>
    </ion-buttons>
  </ion-toolbar>

  <div class="profile-main">
    <div class="avatar-wrap">
      <ion-avatar>
        @if (loadingPage()) {
        <ion-skeleton-text
          animated
          style="width: 104px; height: 104px; border-radius: 9999px"
        ></ion-skeleton-text>
        } @else {
        <img [src]="avatarSrc()" alt="Profile avatar" />
        }
      </ion-avatar>

      <button
        class="avatar-edit-btn"
        (click)="openAvatarSheet()"
        aria-label="Edit avatar"
      >
        <ion-icon name="camera-outline"></ion-icon>
      </button>
    </div>

    @if (loadingPage()) {
    <div class="name-skeleton">
      <ion-skeleton-text
        animated
        style="width: 160px; height: 20px"
      ></ion-skeleton-text>
      <ion-skeleton-text
        animated
        style="width: 80px; height: 16px; margin-top: 6px"
      ></ion-skeleton-text>
    </div>
    } @else {
    <h2 class="profile-name">{{ displayName() }}</h2>

    <div class="rating-row">
      <ion-icon name="star" class="rating-icon"></ion-icon>
      <span class="rating-value">{{ rating() | number : '1.1-1' }}</span>
    </div>
    }
  </div>

  <section class="summary-cards">
    <article
      class="summary-card"
      (click)="openRateModal()"
      role="button"
      aria-label="Edit my rate"
    >
      <div class="summary-card-header">
        <span class="summary-label">My Rate</span>
        <ion-icon name="create-outline"></ion-icon>
      </div>
      <div class="summary-value primary">
        @if (hourlyRateLabel()) { {{ hourlyRateLabel() }} } @else {
        <span class="placeholder">Set in Job Preferences</span>
        }
      </div>
    </article>
  </section>
</ion-header>

<ion-content
  [fullscreen]="true"
  class="profile-content"
  fixed-slot-placement="before"
>
  <div class="profile-body">
    <section class="profile-section">
      <h2 class="section-heading">Work Profile</h2>

      <ion-list class="profile-list">
        <ion-item
          button
          detail="false"
          class="profile-item"
          [routerLink]="['personal-details']"
          routerDirection="forward"
        >
          <div class="profile-item-inner">
            <div class="profile-item-text">
              <div class="profile-item-title">Personal Details</div>
              <div class="profile-item-subtitle">Name, phone number, sex</div>
            </div>
            <ion-icon
              name="chevron-forward-outline"
              class="profile-item-chevron"
              aria-hidden="true"
            ></ion-icon>
          </div>
        </ion-item>

        <ion-item
          button
          detail="false"
          class="profile-item"
          [routerLink]="['job-preferences']"
          routerDirection="forward"
        >
          <div class="profile-item-inner">
            <div class="profile-item-text">
              <div class="profile-item-title">Job Preferences</div>
              <div class="profile-item-subtitle">
                Location, pay rate, trade categories
              </div>
            </div>
            <ion-icon
              name="chevron-forward-outline"
              class="profile-item-chevron"
              aria-hidden="true"
            ></ion-icon>
          </div>
        </ion-item>

        <ion-item
          button
          detail="false"
          class="profile-item"
          [routerLink]="['certificate-management']"
          routerDirection="forward"
        >
          <div class="profile-item-inner">
            <div class="profile-item-text">
              <div class="profile-item-title">Certificates</div>
              <div class="profile-item-subtitle">
                Upload certifcates and qualifications
              </div>
            </div>
            <ion-icon
              name="chevron-forward-outline"
              class="profile-item-chevron"
              aria-hidden="true"
            ></ion-icon>
          </div>
        </ion-item>
      </ion-list>
    </section>

    <section class="profile-section">
      <h2 class="section-heading">Help &amp; Support</h2>

      <ion-list class="profile-list">
        <ion-item
          button
          detail="false"
          class="profile-item"
          [routerLink]="['support']"
          routerDirection="forward"
        >
          <div class="profile-item-inner">
            <div class="profile-item-text">
              <div class="profile-item-title">Support</div>
              <div class="profile-item-subtitle">
                AI support, help to answer any questions
              </div>
            </div>
            <ion-icon
              name="chevron-forward-outline"
              class="profile-item-chevron"
              aria-hidden="true"
            ></ion-icon>
          </div>
        </ion-item>
      </ion-list>
    </section>

    <div class="ion-text-center ion-margin-top ion-margin-bottom">
      <button class="logout-row" type="button" (click)="logout()">
        <ion-icon name="log-out-outline" class="logout-icon"></ion-icon>
        <span>Logout</span>
      </button>

      <ion-button
        class="delete-account-btn"
        expand="block"
        color="danger"
        fill="solid"
        type="button"
        [disabled]="isDeletingAccount()"
        (click)="openDeleteAccountConfirm()"
        aria-label="Delete account"
      >
        <ion-icon slot="start" name="trash-outline"></ion-icon>
        Delete account
      </ion-button>

      <ion-text class="delete-hint">
        <p>This permanently deletes your account and associated data.</p>
      </ion-text>
    </div>

    <ion-alert
      [isOpen]="deleteConfirmOpen()"
      header="Delete account?"
      message="This will permanently delete your account and data. This action cannot be undone."
      [buttons]="deleteAlertButtons"
      (didDismiss)="deleteConfirmOpen.set(false)"
    ></ion-alert>
  </div>
</ion-content>

<ion-modal
  [isOpen]="rateModalOpen()"
  (didDismiss)="closeRateModal()"
  [initialBreakpoint]="0.5"
  [breakpoints]="[0, 0.5, 0.7]"
  class="rate-modal"
>
  <ng-template>
    <ion-header>
      <ion-toolbar>
        <div class="modal-title">My Rate</div>
      </ion-toolbar>
    </ion-header>

    <ion-content class="ion-padding">
      <form [formGroup]="myRateForm">
        <div class="rate-modal-body">
          <label class="field-label" for="rate-hourly">Hourly Rate</label>
          <ion-item class="range-item ion-no-padding">
            <ion-range
              id="rate-hourly"
              formControlName="hourlyRate"
              [pin]="true"
              [pinFormatter]="formatHourly"
              min="5"
              max="100"
              step="1"
            ></ion-range>
          </ion-item>

          <label class="field-label" for="rate-day">Day Rate</label>
          <ion-item class="range-item ion-no-padding">
            <ion-range
              id="rate-day"
              formControlName="dayRate"
              [pin]="true"
              [pinFormatter]="formatDaily"
              min="50"
              max="1000"
              step="10"
            ></ion-range>
          </ion-item>

          <ion-button
            expand="block"
            color="primary"
            class="rate-confirm-btn"
            [disabled]="myRateForm.invalid || myRateForm.pristine"
            (click)="onConfirmRate()"
          >
            Confirm
          </ion-button>
        </div>
      </form>
    </ion-content>
  </ng-template>
</ion-modal>

<ion-action-sheet
  [isOpen]="isAvatarSheetOpen()"
  (didDismiss)="isAvatarSheetOpen.set(false)"
  header="Change profile photo"
  [buttons]="[
    { text: 'Take photo', icon: 'camera-outline', role: 'camera' },
    { text: 'Choose from library', icon: 'image-outline', role: 'photos' },
    { text: 'Cancel', role: 'cancel' }
  ]"
  (ionActionSheetDidDismiss)="onActionSheetDismiss($event)"
>
</ion-action-sheet>

<ion-loading [isOpen]="isUploading()" message="Uploading..."></ion-loading>

<ion-toast
  [isOpen]="toastMsg() !== ''"
  [message]="toastMsg()"
  duration="1800"
  (didDismiss)="toastMsg.set('')"
></ion-toast>
